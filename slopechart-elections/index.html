<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <title>Slopechart</title>
    <style type="text/css">

    .chart-title{
        font-family: sans-serif;
        font-size:25px;
    }

    .chart-subtitle{
        font-family: sans-serif;
        font-size:15px;
    }

    .slope{
        stroke:#666;
        fill:#FFF;
    }

    .slope circle{
        stroke:#FFF;
    }

    .CDU{

    }
    .SPD{

    }
    .FDP{

    }
    .Green{

    }
    .Left{

    }
    .AfD{
        stroke:#F00;
    }

    .label{
        fill:#666;
        stroke:none;
        text-anchor:middle;
        alignment-baseline:central;
    }

    .label.end{
        fill:#666;
        stroke:none;
        text-anchor:start;
    }

    .label.start{
        fill:#666;
        stroke:none;
        text-anchor:end;
    }

    .label{
        font-family: sans-serif;
        font-size: 10px;
    }

    </style>
    <script src="//d3js.org/d3.v4.0.0-alpha.24.min.js" charset="utf-8"></script>
<script src="chartframe.min.js" charset="utf-8">
</script>
</head>
<body>
<svg class="chart"></svg>
</body>

<script type="text/javascript">
    function multiExtent(array, accessor){
        var extent = d3.extent(accessor( array[0] ));

        array.forEach(function(d){
            var elementExtent = d3.extent(accessor(d));
            extent[0] = Math.min(elementExtent[0], extent[0]);
            extent[1] = Math.max(elementExtent[1], extent[1]);
        })
        return extent;
    }
</script>

<script type="text/javascript">
    function slopeChart(){
        var yScale = d3.scaleLinear();
        var xScale = d3.scalePoint();
        var dotRadius = 5;
        var leftLabel = function(){ return ''; };
        var rightLabel = function(){ return ''; };
        var classer = function(){ return '' }

        function chart(parent, data){
            parent.selectAll('g')
                    .data(data)
                .enter()
                    .append('g')
                    .attr('class',classer)
                    .each(function(datum){
                        var group = d3.select(this);

                        //lines
                        var lineSegments = xScale.domain().reduce(function(previousValue, currentValue, currentIndex, array){
                            if(currentIndex>0){
                                previousValue.push({
                                    start:array[currentIndex-1],
                                    end:currentValue
                                });
                            }
                            return previousValue;
                        }, []);

                        group.selectAll('line')
                            .data(lineSegments)
                                .enter()
                            .append('line')
                                .attr('x1', function(d){
                                    return xScale(d.start);
                                })
                                .attr('x2', function(d){
                                    return xScale(d.end);
                                })
                                .attr('y1', function(d){
                                    return yScale(datum[d.start]);
                                })
                                .attr('y2', function(d){
                                    return yScale(datum[d.end]);
                                });
                        //dots
                        if(dotRadius > 0){
                            group.selectAll('circle')
                                .data(xScale.domain())
                                    .enter()
                                 .append('circle')
                                    .attr('r',dotRadius)
                                    .attr('cx',function(d){
                                        return xScale(d)
                                    })
                                    .attr('cy',function(d){
                                        return yScale(datum[d])
                                    });
                        }
                        //labels
                        group.selectAll('text')
                            .data(xScale.domain())
                                .enter()
                            .append('text')
                                .attr('class',function(d, i){
                                    if(i==0){
                                        return 'start label';
                                    }
                                    if(i==xScale.domain().length-1){
                                        return 'end label';
                                    }
                                    return 'label';
                                })
                                .attr('x',function(d){
                                    return xScale(d);
                                })
                                .attr('y',function(d){
                                    return yScale(datum[d]);
                                })
                                .text(function(d,i){
                                    if(i == 0) return leftLabel(datum);
                                    if(i == xScale.domain().length-1) return rightLabel(datum);
                                    return datum[d];
                                })
//                        console.log(datum);
                    })
        }

        chart.classer = function(accessor){
            classer = accessor;
            return chart;
        }

        chart.dotRadius = function(r){
            if(isNaN(r)) return dotRadius;
            dotRadius = r;
            return chart;
        }

        chart.xScale = function(scale){
            if(!scale) return xScale;
            xScale = scale;
            return chart;
        }

        chart.yScale = function(scale){
            if(!scale) return yScale;
            yScale = scale;
            return chart;
        }

        chart.leftLabel = function(accessor){
            if(!accessor) return leftLabel;
            leftLabel = accessor;
            return chart;
        }

        chart.rightLabel = function(accessor){
            if(!accessor) return rightLabel;
            rightLabel = accessor;
            return chart;
        }

        chart.slopeColour = function(accessor){
            if(!accessor) return slopeColour;
            slopeColour = accessor;
            return chart;
        }

        return chart;
    }
</script>
<script>

    d3.csv("test2.csv", function(error, data) {

        var columns = ['2011', '2016', '2021'];

        var frame = d3_chartframe.frame()
                        .title("Saxony-Anhalt state election, 2016")
                        .subtitle("Vote by party vs 2011")
                        .source("Source: Spiegel.de")
                        .margin({top:90, left:60, bottom:60, right:70});

        var xScale = d3.scalePoint()
                        .domain(columns)
                        .range([0, frame.dimension().width]);

        var yScale = d3.scaleLinear()
                        .domain(multiExtent(data, function(d){
                            var elements = [];
                            xScale.domain().forEach(function(key){
                                elements.push(d[key]);
                            });
                            return elements;
                        }))
                        .range([frame.dimension().height, 0]);
        
        var slopes = slopeChart()
                        .leftLabel(function(d){ return d[columns[0]]; })
                        .rightLabel(function(d){ return d[columns[1]] + ' ' + d.party; })
                        .classer(function(d){ return 'slope ' + d.party; })
                        .dotRadius(10)
                        .xScale(xScale)
                        .yScale(yScale);

        // console.log(xScale.range())
        // console.log(yScale.domain())

        d3.select('svg.chart')
            .call( frame );

        d3.select('svg.chart .chart-plot')
            .call( slopes, data );

});

    </script>

</html>