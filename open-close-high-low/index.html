<html>
<head>
	<title>Open-high-low-close chart</title>
	<script type="text/javascript" src="../d3/d3.v3.min.js"></script>
	<style type="text/css">
		*{
			font-family: sans-serif;
		}
		
		.y.axis .domain,
		.x.axis .domain{
			fill:none;
			stroke:#a7a59b;
		}

		.y.axis .domain {
			stroke: none;
		}

		.y.axis .tick line,
		.x.axis .tick line{
			fill:none;
			stroke:#cec6b9;
		}

		.y.axis .tick text,
		.x.axis .tick text{
			fill:#74736c;
			font-size: 14px;
		}

		.day line {
			stroke-width: 2px;
			shape-rendering: crispEdges;
		}
	</style>
</head>

<body>
	<h1>Open-high-low-close chart</h1>
	<a href="https://github.com/ft-interactive/graphics-examples/tree/master/open-close-high-low">source</a>

	<div class="chart">
	</div>
	<div class="key">
	</div>
</body>

<script type="text/javascript">

//Configuration
var data = 'apple-stockprice-data.csv',	//The spreadsheet where the data comes from
	chartWidth = 600,
	chartHeight = 400,
	margin = { top:50, bottom:50, left:50, right:20 },
	plotWidth = chartWidth - (margin.left + margin.right),
	plotHeight = chartHeight - (margin.top + margin.bottom),
	riseColour = '#0e6dcc',
	fallColour = '#cc0000',
	lineWidth = 5,
	dateFormat = d3.time.format("%Y-%m-%d"),	//default date format is of the form 2015-04-22

	// this is what the columns of data are called, hopefully the defaulst are self explanatory...
	open = "Open Price",	
	high = "High Price",
	low = "Low Price",
	close = "Close Price",
	date = "Date"; 


//Load the data, when it's loaded draw the chart
d3.csv(data, drawChart);


//The function that does the actual drawing
function drawChart(loadedData){

	var processedData = loadedData.map(function(d){
		return {
			date:dateFormat.parse( d[date] ),
			open:Number(d[ open ]),
			close:Number(d[ close ]),
			high:Number(d[ high ]),
			low:Number(d[ low ])
		};
	});


//create the scales
	var xScale = d3.time.scale()
		.domain( d3.extent(processedData, function(d){ return d.date; } ) )
		.range( [0, plotWidth] )
		.nice();


	var yScale = d3.scale.linear()
		.domain( [
			d3.min(processedData, function(d){ return d.low; }),
			d3.max(processedData, function(d){ return d.high; }),
		] )
		.range( [0, plotHeight] )
		.nice();

	
//create the chart itself
	var svg = d3.select('.chart') // attach this to the first div with the class chart
		.append('svg')	// add the SVG tot he page
		.attr({
			width: chartWidth,
			height: chartHeight
		});


//create the axes
	var axes = svg.append('g')
			.attr({ 
				'class':'axes',
				'transform':'translate(' + margin.left + ',' + margin.top + ')' 
			});


	axes.append('g')
		.attr({
			'class':'x axis',
			'transform':'translate(0,'+plotHeight+')'
		})
		.call( d3.svg.axis().scale(xScale) );


	axes.append('g')
		.attr({
			'class':'y axis',
			'transform':'translate('+(chartWidth - (margin.right + margin.left))+',0)'
		})
		.call( d3.svg.axis()
				.scale(yScale)
				.orient('left')
				.tickSize(chartWidth - (margin.right + margin.left) + 10) )

	
	var mark = OHLCMark()	//create the mark drawer
		.scale(yScale)
		.riseColour(riseColour)
		.fallColour(fallColour);


//plot the data
	var plot = svg.append('g')
			.attr({ 
				transform:'translate(' + margin.left + ',' + margin.top + ')' 
			});

	
	plot.selectAll('.day')
		.data(processedData)
			.enter()
		.append('g') // add the data
			.attr({
				'class':'day',
				'transform':function(d){ return 'translate(' + xScale(d.date) + ',0)'; }
			})
			.call( mark );
}


//this is the code that draws the individual marks
function OHLCMark(){
	var scale = d3.scale.linear();
	var riseColour = '#00FF00';
	var fallColour = '#FF0000';

	function colourScale(d){ 
		if(d.close>d.open){ return fallColour; }
		return riseColour;
	}

	function chart(parent){
		parent.append('line') //high low line
			.attr({
				x1:0, 
				y1:function(d){ return scale(d.high); }, 
				x2:0, 
				y2:function(d){ return scale(d.low); },
				'stroke':colourScale
			}); 

		//open line	
		parent.append('line').attr({
				x1:-lineWidth, 
				y1:function(d){ return scale(d.open); }, 
				x2:0, 
				y2:function(d){ return scale(d.open); }, 
				'stroke':colourScale
			}); 

		//close line
		parent.append('line').attr({
				x1:lineWidth, 
				y1:function(d){ return scale(d.close); }, 
				x2:0, 
				y2:function(d){ return scale(d.close); }, 
				'stroke':colourScale
			}); 
	}

	chart.scale = function(s){
		scale = s;
		return chart;
	}

	chart.riseColour = function(c){
		riseColour = c;
		return chart;
	}

	chart.fallColour = function(c){
		fallColour = c;
		return chart;
	}

	return chart;
}

</script>
</html>