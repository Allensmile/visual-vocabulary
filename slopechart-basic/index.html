<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <title>Slopechart</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
    <script src="http://ft-interactive.github.io/graphics-examples/shared/js/chartframe.js" type="text/javascript"></script>
    <link rel="stylesheet" type="text/css" href="http://ft-interactive.github.io/graphics-examples/shared/css/chartframe.css">
</head>
<body>

<script>
    
function extent(array, props){
    
    var allValues = array.reduce(function(previousValue, currentValue, currentIndex, array){
        var values = props.map( function(p){ return Number(currentValue[p]); } )
        return values.concat(previousValue)
    },[]);

    return d3.extent(allValues);
}

d3.csv('data.csv', function(error, data) {
    
    //titles
    var title = 'Education and pay';
    var subtitle = 'by country world rank';
    var source = 'Source: forumchart.xls';
    var col1 = 'Education system';
    var col2 = 'Pay and productivity';
    
    //slope config
    var startZero = true;
    var showDots = true;
    var showLabels = true;
    var showValues = true;
    
    //styling as attributes
    var styles = {
        'text':{
            'font-family':'Metric, sans-serif'
        },
        '.end-label':{
            'font-size':10,
            'text-anchor':'start',
            'dx':5
        },
        '.start-label':{
            'font-size':'10',
            'text-anchor':'end',
            'dx':-5
        },
        'svg':{
            'width':600,
            'height':1075
        },
        '#slope line':{
            'stroke-width':'2',
            'stroke':'#F19F9E'
        },
        '#slope circle':{
            'fill':'#F19F9E'
        },
        '.colLabel':{
            'font-weight':'600',
            'font-size':'14',
            'dy':-10
        },
        '.axis line':{
            'fill':'none',
            'stroke':'#c1b5a7',
            'stroke-width':'1',
            'stroke-dasharray':'1,2',
            'shape-rendering':'crispEdges'
        },
        '.axis .domain':{
            'fill':'none',
            'stroke':'none'
        },
        '.axis text':{
            'font-size':'12',
            'fill':'#c1b5a7'
        }
   } 
    
    //workout domain of the data
    var dataDomain = extent(data,['val1','val2']);
    //anchor to zero if needed
    if (startZero) dataDomain[0] = 0;

    //document structure
    var svg = d3.select("body").append("svg").attr(styles.svg);

    var frame = chartFrame()
        .title( title )
        .subtitle( subtitle )
        .source( source )
        .margin( {left:170, right:190, top:80} )
        .height( styles.svg.height )
        .width( styles.svg.width );

    //create scale for y axis
    var yScale = d3.scale.linear()
        .domain( dataDomain )
        .range( [frame.dimension().height,0] )
    
    //axis
    var yAxis = d3.svg.axis()
        .scale( yScale )
        .orient( 'right' )
        .ticks( 5 )
        .tickSize( frame.dimension().width )

    svg.call( frame );
    
    //axis
    var plot = d3.select('.chart-plot');

    plot.append('g').attr('class','axis')
        .call(yAxis);
    
    //create graph
    var graph = plot.append('g').attr('id','slope');
    
    var slopes = graph.selectAll("g").data(data).enter().append("g").attr("id",function(d){return d.name})
    
    slopes.append("line")
        .attr({
            'x1':0,
            'x2':frame.dimension().width,
            'y1':function(d){ return yScale(d.val1); },
            'y2':function(d){ return yScale(d.val2); }
        });
    
    //create dots if requested
    if (showDots)   {
        slopes.append('circle')
            .attr({
                'r':3,
                'cx':0,
                'cy':function(d){ return yScale(d.val1); }
            });

        slopes.append('circle')
            .attr({
                'r':3,
                'cx':frame.dimension().width,
                'cy':function(d){ return yScale(d.val2); }
            });
    }
    
    //create labels if needed
    if (showLabels) {
        slopes.append('text')
            .attr({
                'class':'start-label',
                'y':function(d){ return yScale(d.val1) + 5; }
            })
            .text(function(d){
                if (showValues){
                    return d.name+" "+d.val1;
                } else {
                    return d.name;
                }
            });

        slopes.append('text')
            .attr({
                'class':'end-label',
                'x':frame.dimension().width,
                'y':function(d){ return yScale(d.val2) + 5; }
            })
            .text(function(d){
                if (showValues){
                    return d.val2 + ' ' + d.name;
                } else {
                    return d.name;
                }
            });
    }
    
    //column headings
    svg.append("text")
        .attr("x",frame.margin().left)
        .attr("y",frame.margin().top)
        .attr("class","colLabel")
        .attr("text-anchor","end")
        .text(col1);
    
    svg.append("text")
        .attr("x",frame.width() - frame.margin().right)
        .attr("y",frame.margin().top)
    .attr("class","colLabel")
        .text(col2);
    
    //apply the styles as attributes
    d3.selectAll('*').attr('style', null);
    Object.keys(styles).forEach(function(selector){
        d3.selectAll(selector)
            .attr(styles[selector]);
    }); 

});

</script>
</body>
</html>